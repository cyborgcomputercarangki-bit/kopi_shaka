<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHAKA POS - Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #d4a373; --bg: #0a0a0a; --card: #161616; --text: #ffffff; --text-dim: #a0a0a0; --bright-green: #82c91e; --error: #ff3d00; }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; background-image: radial-gradient(circle at 50% -20%, #2c1e1a 0%, #0a0a0a 80%); }
        header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; background: rgba(20,20,20,0.8); backdrop-filter: blur(15px); border-bottom: 1px solid #222; }
        .main-content { flex: 1; overflow-y: auto; padding-bottom: 120px; }
        .page { display: none; padding: 20px; max-width: 900px; margin: 0 auto; animation: pageIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes pageIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-btn-group { display: flex; gap: 8px; margin-bottom: 12px; }
        .tab-btn { flex: 1; background: #1a1a1a; border: 1px solid #333; color: #777; padding: 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 800; cursor: pointer; text-align: center; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }

        .filter-group { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .filter-group::-webkit-scrollbar { display: none; }
        .filter-btn { flex: 0 0 auto; background: #1a1a1a; border: 1px solid #333; color: #777; padding: 10px 18px; border-radius: 50px; font-size: 0.7rem; font-weight: 800; cursor: pointer; white-space: nowrap; transition: 0.3s; letter-spacing: 1px; }
        .filter-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }

        .trx-card { background: var(--card); border: 1px solid #222; border-radius: 20px; padding: 18px; margin-bottom: 12px; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .img-container { width: 100%; height: 110px; background: #111; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }

        .menu-name { color: #ffffff; font-weight: 800; font-size: 0.85rem; display: block; margin-bottom: 4px; line-height: 1.2; }
        .menu-price { color: var(--primary); font-weight: 600; font-size: 0.8rem; display: block; }
        .menu-stock { font-size: 0.65rem; font-weight: 800; display: inline-block; margin-top: 8px; padding: 3px 10px; border-radius: 8px; }
        .stock-safe { color: var(--bright-green); background: rgba(130, 201, 30, 0.15); border: 1px solid rgba(130, 201, 30, 0.3); }
        .stock-low { color: var(--error); background: rgba(255, 61, 0, 0.15); border: 1px solid rgba(255, 61, 0, 0.3); }
        
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #222; }
        .qty-control { display: flex; align-items: center; gap: 12px; background: #222; padding: 6px; border-radius: 15px; border: 1px solid #333; }
        .qty-btn { background: var(--primary); color: #000; border: none; width: 35px; height: 35px; border-radius: 10px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .taskbar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(28,28,28,0.9); backdrop-filter: blur(20px); height: 75px; border-radius: 25px; display: flex; border: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #555; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item span { font-size: 0.6rem; font-weight: 800; margin-top: 4px; }

        input, select { background: #222; border: 1px solid #333; color: white; padding: 15px; border-radius: 18px; width: 100%; margin-bottom: 12px; outline: none; appearance: none; }
        .btn-main { background: var(--primary); color: #000; border: none; padding: 16px; border-radius: 18px; font-weight: 800; width: 100%; cursor: pointer; }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card); padding: 30px; border-radius: 35px; width: 100%; max-width: 400px; border: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        #toast { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); background: var(--primary); color: black; padding: 12px 25px; border-radius: 50px; font-weight: 800; font-size: 0.85rem; z-index: 5000; display: none; }
    </style>
</head>
<body>

<div id="toast">Notifikasi</div>

<div id="loginPage" style="position:fixed; inset:0; background:var(--bg); z-index:9999; display:flex; align-items:center; justify-content:center; padding:30px;">
    <div style="background:var(--card); padding:50px 40px; border-radius:45px; width:100%; max-width:400px; text-align:center; border:1px solid #222;">
        <h1 style="color:var(--primary); font-weight:800; letter-spacing:5px; margin:0;">SHAKA</h1>
        <p style="color:var(--bright-green); font-size:0.75rem; margin-bottom:40px; font-weight:800; letter-spacing:2px;">COFFEE INTELLIGENCE</p>
        
        <div id="loginOptions">
            <button class="btn-main" onclick="loginAsKasir()" style="margin-bottom: 15px;">KASIR</button>
            <button class="btn-main" onclick="showAdminLogin()" style="background:#444; color:white;">ADMIN</button>
        </div>

        <div id="adminLoginForm" style="display:none;">
            <input type="password" id="pass" placeholder="Password Admin">
            <button class="btn-main" onclick="doAdminLogin()">SIGN IN ADMIN</button>
            <button class="btn-main" onclick="backToOptions()" style="background:none; color:var(--text-dim); margin-top:10px; font-size:0.7rem;">KEMBALI</button>
        </div>
    </div>
</div>

<header>
    <div>
        <h1 style="color:var(--primary); font-size:1.2rem; letter-spacing:2px; font-weight:800; margin:0;">SHAKA.</h1>
        <small id="activeUser" style="color:var(--text-dim); font-weight:800;"></small>
    </div>
    <button onclick="location.reload()" style="background:none; border:none; color:var(--error); font-weight:800; cursor:pointer;">LOGOUT</button>
</header>

<div class="main-content">
    <div id="p-kasir" class="page active">
        <input type="text" id="cName" placeholder="Nama Pelanggan" style="margin-bottom:10px">
        <div class="tab-btn-group">
            <div id="f1" class="tab-btn active" onclick="setFloor('Lantai 1')">LANTAI 1</div>
            <div id="f2" class="tab-btn" onclick="setFloor('Lantai 2')">LANTAI 2</div>
        </div>
        <input type="text" id="menuSearch" placeholder="Cari Menu..." style="margin-bottom:15px">
        
        <div class="filter-group" id="catBarKasir">
            <div class="filter-btn active" onclick="filterCat('ALL', this)">üè† SEMUA</div>
            <div class="filter-btn" onclick="filterCat('COFFEE', this)">‚òï COFFEE</div>
            <div class="filter-btn" onclick="filterCat('TEA', this)">üçÉ TEA</div>
            <div class="filter-btn" onclick="filterCat('COKELAT', this)">üç´ COKELAT</div>
            <div class="filter-btn" onclick="filterCat('SQUASH', this)">üçπ SQUASH</div>
            <div class="filter-btn" onclick="filterCat('MILKSHAKE', this)">ü•§ MILKSHAKE</div>
            <div class="filter-btn" onclick="filterCat('SNACK', this)">ü•ê SNACK</div>
        </div>

        <div id="menuGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:12px;"></div>
        
        <div style="background:rgba(255,255,255,0.03); border-radius:30px; padding:25px; margin-top:30px; border:1px solid #222;">
            <div id="cartList"></div>
            <div style="display:flex; justify-content:space-between; margin:20px 0">
                <span style="color:var(--text-dim); font-weight:700">TOTAL</span>
                <span id="totalPrice" style="color:var(--primary); font-size:1.8rem; font-weight:800">Rp 0</span>
            </div>
            <button class="btn-main" onclick="openPayment()">BAYAR SEKARANG</button>
        </div>
    </div>

    <div id="p-history" class="page">
        <h2 style="color:var(--primary)">History</h2>
        <div id="hList"></div>
    </div>

    <div id="p-rekap" class="page">
        <h2 style="color:var(--primary)">Stats</h2>
        <div class="filter-group">
            <div class="filter-btn active" onclick="setFilterMode('all', this)">Semua</div>
            <div class="filter-btn" onclick="setFilterMode('hari', this)">Hari</div>
            <div class="filter-btn" onclick="setFilterMode('bulan', this)">Bulan</div>
            <div class="filter-btn" onclick="setFilterMode('tahun', this)">Tahun</div>
        </div>
        <input type="date" id="selDay" onchange="runFilter(this.value)" style="position:absolute; visibility:hidden; width:0; height:0;">
        <div id="rekapSummary"></div>
        <div id="rekapDetail" style="margin-top:20px;"></div>
    </div>

    <div id="p-admin" class="page">
        <h2 style="color:var(--primary)">Inventory</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <button class="btn-main" onclick="openAddMenu()">+ TAMBAH MENU</button>
            <button class="btn-main" style="background:#444; color:white;" onclick="alert('Fitur Import nonaktif dalam mode gambar Base64')">‚ö° IMPORT DATA</button>
        </div>
        <div id="adminList"></div>
    </div>
</div>

<div class="taskbar">
    <div class="nav-item active" onclick="tab('kasir', this)"><i>üõí</i><span>KASIR</span></div>
    <div class="nav-item" onclick="tab('history', this)"><i>üìú</i><span>HISTORY</span></div>
    <div class="nav-item" onclick="tab('rekap', this)"><i>üìä</i><span>STATS</span></div>
    <div id="adm-nav" class="nav-item" style="display:none" onclick="tab('admin', this)"><i>‚öôÔ∏è</i><span>ADMIN</span></div>
</div>

<div id="payModal" class="modal">
    <div class="modal-content">
        <h2 style="text-align:center; color:var(--primary);">Pembayaran</h2>
        
        <div id="payCartList" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;"></div>
        
        <div id="payTotal" style="font-size:2.2rem; font-weight:800; text-align:center; margin-bottom:20px; color:var(--primary)"></div>
        <input type="number" id="payAmount" placeholder="Nominal Tunai" oninput="calcChange()">
        <div style="display:flex; justify-content:space-between; padding:15px 0">
            <span>Kembali</span>
            <b id="payChange">Rp 0</b>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;">
            <button class="btn-main" onclick="confirmTrx()">KONFIRMASI</button>
            <button class="btn-main" style="background:var(--error); color:white;" onclick="cancelTrx()">BATAL</button>
        </div>
        <button class="btn-main" style="background:none; color:var(--text-dim); font-size:0.75rem; margin-top:10px;" onclick="closeModal()">LANJUT PILIH MENU</button>
    </div>
</div>

<div id="successModal" class="modal"><div class="modal-content" style="text-align:center"><div style="font-size:4rem; color:var(--bright-green)">‚úì</div><h2>Berhasil</h2><button class="btn-main" onclick="printStrukLastTrx()" style="background:#444; color:white; margin-bottom:10px">üñ®Ô∏è CETAK STRUK</button><button class="btn-main" onclick="resetKasir()">üè† SELESAI</button></div></div>

<div id="adminModal" class="modal">
    <div class="modal-content">
        <h2 id="adm-title">Input Menu</h2>
        <input type="hidden" id="adm-id">
        <div id="img-preview-container" style="width:100%; height:150px; background:#222; border-radius:18px; margin-bottom:15px; overflow:hidden; display:flex; align-items:center; justify-content:center; border:1px dashed #444;">
            <img id="img-preview" src="" style="display:none; width:100%; height:100%; object-fit:cover;">
            <span id="img-placeholder" style="color:#555; font-size:0.7rem; font-weight:800;">üì∑ BELUM ADA FOTO</span>
        </div>
        <input type="text" id="adm-name" placeholder="Nama Menu">
        <select id="adm-cat">
            <option value="COFFEE">‚òï COFFEE</option>
            <option value="TEA">üçÉ TEA</option>
            <option value="COKELAT">üç´ COKELAT</option>
            <option value="SQUASH">üçπ SQUASH</option>
            <option value="MILKSHAKE">ü•§ MILKSHAKE</option>
            <option value="SNACK">ü•ê SNACK</option>
        </select>
        <input type="number" id="adm-price" placeholder="Harga Jual">
        <input type="number" id="adm-stock" placeholder="Stok">
        <label for="adm-file" style="display:block; background:#333; color:var(--primary); padding:15px; border-radius:15px; text-align:center; font-size:0.75rem; font-weight:800; cursor:pointer; margin-bottom:12px; border:1px solid var(--primary);">üì∑ AMBIL FOTO PRODUK</label>
        <input type="file" id="adm-file" accept="image/*" style="display:none" onchange="previewImage(this)">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px">
            <button class="btn-main" id="btnSaveAdmin" onclick="saveAdminMenu()">SIMPAN</button>
            <button class="btn-main" style="background:none; border:1px solid #444; color:white" onclick="closeModal()">BATAL</button>
        </div>
    </div>
</div>

<div id="editTrxModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--primary)">Edit Riwayat</h2>
        <input type="hidden" id="et-id">
        <label style="font-size: 0.7rem; color: var(--text-dim);">NAMA PELANGGAN</label>
        <input type="text" id="et-nama">
        <label style="font-size: 0.7rem; color: var(--text-dim);">LOKASI</label>
        <select id="et-lokasi">
            <option value="Lantai 1">Lantai 1</option>
            <option value="Lantai 2">Lantai 2</option>
        </select>
        <label style="font-size: 0.7rem; color: var(--text-dim);">TOTAL HARGA (Rp)</label>
        <input type="number" id="et-total">
        <label style="font-size: 0.7rem; color: var(--text-dim);">TUNAI/BAYAR (Rp)</label>
        <input type="number" id="et-bayar">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:20px">
            <button class="btn-main" onclick="saveEditTrx()">UPDATE</button>
            <button class="btn-main" style="background:none; border:1px solid #444; color:white" onclick="closeModal()">BATAL</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAf4pkzvpCuzmXquzIoCDXLAr6-_l3i8O0", authDomain: "kopi-shaka.firebaseapp.com", projectId: "kopi-shaka", storageBucket: "kopi-shaka.firebasestorage.app", messagingSenderId: "947498895962", appId: "1:947498895962:web:ebb8bc420bdbc47e086663" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    
    let menus = [], cart = [], allTrx = [], currentFilterMode = 'all', lastTrxData = null, selectedCat = 'ALL', currentUser = '', currentFloor = 'Lantai 1', base64String = "";

    window.loginAsKasir = () => {
        currentUser = "PUSPA";
        document.getElementById('activeUser').innerText = "KASIR: " + currentUser;
        document.getElementById('adm-nav').style.display = 'none';
        document.getElementById('loginPage').style.display = 'none';
    };

    window.showAdminLogin = () => {
        document.getElementById('loginOptions').style.display = 'none';
        document.getElementById('adminLoginForm').style.display = 'block';
    };

    window.backToOptions = () => {
        document.getElementById('loginOptions').style.display = 'block';
        document.getElementById('adminLoginForm').style.display = 'none';
    };

    window.doAdminLogin = () => {
        const p = document.getElementById('pass').value;
        if(p === 'shaka123') {
            currentUser = "ADMIN";
            document.getElementById('activeUser').innerText = "MODE: " + currentUser;
            document.getElementById('adm-nav').style.display = 'flex';
            document.getElementById('loginPage').style.display = 'none';
        } else { alert("Password Admin Salah!"); }
    };

    window.tab = (id, el) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('p-'+id).classList.add('active'); el.classList.add('active');
        if(id==='history' || id==='rekap') loadTrxData();
    };

    onSnapshot(collection(db, "menus"), (snap) => {
        menus = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name));
        renderMenuGrid(); renderAdmin();
    });

    window.setFloor = (fl) => { currentFloor = fl; document.getElementById('f1').classList.toggle('active', fl === 'Lantai 1'); document.getElementById('f2').classList.toggle('active', fl === 'Lantai 2'); };
    
    window.filterCat = (cat, el) => { 
        selectedCat = cat; 
        document.querySelectorAll('#p-kasir .filter-btn').forEach(c => c.classList.remove('active')); 
        el.classList.add('active'); 
        renderMenuGrid(); 
    };

    function renderMenuGrid() {
        const s = document.getElementById('menuSearch').value.toLowerCase();
        const f = menus.filter(m => (selectedCat === 'ALL' || m.category === selectedCat) && m.name.toLowerCase().includes(s));
        document.getElementById('menuGrid').innerHTML = f.map(m => `
            <div class="trx-card" style="padding:0; ${m.stock <= 0 ? 'opacity:0.3; pointer-events:none' : ''}" onclick="addToCart('${m.id}')">
                <div class="img-container">
                    ${m.image ? `<img src="${m.image}" loading="lazy">` : `<span style="font-size:2rem; opacity:0.1;">‚òï</span>`}
                </div>
                <div style="padding:12px; text-align:center;">
                    <span class="menu-name" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.name}</span>
                    <span class="menu-price">Rp ${m.price.toLocaleString()}</span>
                    <span class="menu-stock ${m.stock <= 5 ? 'stock-low' : 'stock-safe'}">${m.stock <= 0 ? 'HABIS' : 'STOK: '+m.stock}</span>
                </div>
            </div>`).join('');
    }

    // KASIR & CART FUNCTIONS
    window.addToCart = (id) => {
        const m = menus.find(x => x.id === id); const ex = cart.find(x => x.id === id);
        if(ex) { if(ex.qty < m.stock) ex.qty++; else return showNotif("Stok Habis!"); } else { cart.push({...m, qty: 1}); }
        updateCart(); showNotif("+ " + m.name);
    };

    function updateCart() {
        let tot = 0;
        document.getElementById('cartList').innerHTML = cart.map(i => {
            tot += (i.price * i.qty);
            return `<div class="cart-item"><div><b style="color:white">${i.name}</b><br><small style="color:var(--primary)">Rp ${(i.price*i.qty).toLocaleString()}</small></div><div class="qty-control"><button class="qty-btn" onclick="updateQty('${i.id}',-1)">-</button><b style="min-width:25px; text-align:center; color:white">${i.qty}</b><button class="qty-btn" onclick="updateQty('${i.id}',1)">+</button></div></div>`;
        }).join('');
        document.getElementById('totalPrice').innerText = 'Rp ' + tot.toLocaleString();
    }

    window.updateQty = (id, delta) => { 
        const i = cart.find(x => x.id === id); 
        i.qty += delta; 
        if(i.qty <= 0) cart = cart.filter(x => x.id !== id); 
        updateCart(); 
    };

    // FITUR BARU: MODAL EDIT & BATAL
    window.updatePayCart = () => {
        let tot = 0;
        document.getElementById('payCartList').innerHTML = cart.map(i => {
            tot += (i.price * i.qty);
            return `<div class="cart-item" style="padding:10px 0"><div style="flex:1"><b style="color:white; font-size:0.75rem">${i.name}</b><br><small style="color:var(--primary)">Rp ${(i.price*i.qty).toLocaleString()}</small></div><div class="qty-control" style="scale:0.8"><button class="qty-btn" onclick="updateQtyInPay('${i.id}',-1)">-</button><b style="min-width:20px; text-align:center; color:white">${i.qty}</b><button class="qty-btn" onclick="updateQtyInPay('${i.id}',1)">+</button></div></div>`;
        }).join('');
        document.getElementById('payTotal').innerText = 'Rp ' + tot.toLocaleString();
        if(cart.length === 0) closeModal();
        calcChange();
    };

    window.updateQtyInPay = (id, delta) => {
        window.updateQty(id, delta);
        window.updatePayCart();
    };

    window.cancelTrx = () => {
        if(confirm("Batalkan semua pesanan?")) {
            cart = [];
            updateCart();
            closeModal();
            document.getElementById('cName').value = '';
            showNotif("Transaksi Dibatalkan");
        }
    };

    window.openPayment = () => { 
        if(cart.length) { 
            window.updatePayCart();
            document.getElementById('payAmount').value = '';
            document.getElementById('payChange').innerText = 'Rp 0';
            document.getElementById('payModal').style.display = 'flex'; 
        } 
    };

    window.confirmTrx = async () => {
        const tot = cart.reduce((a,b)=>a+(b.price*b.qty),0); 
        const pay = parseInt(document.getElementById('payAmount').value) || 0;
        if(pay < tot) return alert("Uang Kurang!");
        const d = { tgl: new Date().toISOString(), nama: document.getElementById('cName').value || 'Guest', lokasi: currentFloor, kasir: currentUser, itemDetails: cart.map(i => ({name: i.name, qty: i.qty, price: i.price})), total: tot, bayar: pay, kembali: pay - tot };
        lastTrxData = d; const b = writeBatch(db);
        await addDoc(collection(db, "transactions"), d);
        cart.forEach(it => { b.update(doc(db, "menus", it.id), { stock: it.stock - it.qty }); });
        await b.commit(); document.getElementById('payModal').style.display='none'; document.getElementById('successModal').style.display='flex';
    };

    // HISTORY & ADMIN FUNCTIONS
    async function loadTrxData() {
        const s = await getDocs(query(collection(db, "transactions"), orderBy("tgl", "desc")));
        allTrx = s.docs.map(d => ({id: d.id, ...d.data()}));
        renderHistory();
        runFilter();
    }

    function renderHistory() {
        document.getElementById('hList').innerHTML = allTrx.map(t => {
            const itemsText = t.itemDetails ? t.itemDetails.map(it => `${it.name} (x${it.qty})`).join(', ') : '';
            return `<div class="trx-card" style="display:flex; justify-content:space-between; align-items:center"><div style="flex:1"><small>${new Date(t.tgl).toLocaleString()}</small><br><div style="display:flex; align-items:baseline; gap:8px"><b style="font-size:1rem">${t.nama}</b><span style="font-size:0.65rem; color:var(--primary); font-weight:800; background:rgba(212,163,115,0.1); padding:2px 8px; border-radius:6px; border:1px solid rgba(212,163,115,0.2)">${t.lokasi || 'Lantai 1'}</span></div><small style="color:var(--text-dim)">${itemsText}</small><br><b style="color:var(--bright-green)">Rp ${t.total.toLocaleString()}</b></div><div style="display:flex; gap:5px"><button onclick="reprintStruk('${t.id}')" style="background:#333; border:none; padding:10px; border-radius:10px">üñ®Ô∏è</button>${currentUser === 'ADMIN' ? `<button onclick="editTrxPrompt('${t.id}')" style="background:var(--primary); border:none; padding:10px; border-radius:10px">‚úèÔ∏è</button><button onclick="deleteTrx('${t.id}')" style="background:var(--error); border:none; padding:10px; border-radius:10px">üóëÔ∏è</button>` : ''}</div></div>`;
        }).join('');
    }

    window.deleteTrx = async (id) => { if(confirm("Hapus history ini?")) { await deleteDoc(doc(db, "transactions", id)); loadTrxData(); showNotif("Riwayat dihapus"); } };

    window.editTrxPrompt = (id) => {
        const t = allTrx.find(x => x.id === id);
        document.getElementById('et-id').value = t.id;
        document.getElementById('et-nama').value = t.nama;
        document.getElementById('et-lokasi').value = t.lokasi || 'Lantai 1';
        document.getElementById('et-total').value = t.total;
        document.getElementById('et-bayar').value = t.bayar;
        document.getElementById('editTrxModal').style.display = 'flex';
    };

    window.saveEditTrx = async () => {
        const id = document.getElementById('et-id').value;
        const nTotal = parseInt(document.getElementById('et-total').value);
        const nBayar = parseInt(document.getElementById('et-bayar').value);
        await updateDoc(doc(db, "transactions", id), { nama: document.getElementById('et-nama').value, lokasi: document.getElementById('et-lokasi').value, total: nTotal, bayar: nBayar, kembali: nBayar - nTotal });
        closeModal(); loadTrxData(); showNotif("Data diperbarui");
    };

    window.runFilter = (v) => {
        let f = allTrx;
        if(v) {
            const sd = new Date(v);
            if(currentFilterMode === 'hari') f = allTrx.filter(t => new Date(t.tgl).toDateString() === sd.toDateString());
            else if(currentFilterMode === 'bulan') f = allTrx.filter(t => new Date(t.tgl).getMonth() === sd.getMonth());
            else if(currentFilterMode === 'tahun') f = allTrx.filter(t => new Date(t.tgl).getFullYear() === sd.getFullYear());
        }
        const t = f.reduce((a,b)=>a+b.total,0);
        document.getElementById('rekapSummary').innerHTML = `<div class="trx-card" style="text-align:center; border:1px solid var(--primary);"><b>TOTAL PENDAPATAN</b><br><span style="font-size:2rem; font-weight:800">Rp ${t.toLocaleString()}</span></div>`;
        document.getElementById('rekapDetail').innerHTML = f.map(tx => `<div class="trx-card" style="display:flex; justify-content:space-between"><div><b>${tx.nama}</b><br><small>${tx.kasir}</small></div><b>Rp ${tx.total.toLocaleString()}</b></div>`).join('');
    };

    window.setFilterMode = (m, el) => {
        currentFilterMode = m; document.querySelectorAll('#p-rekap .filter-btn').forEach(b => b.classList.remove('active')); el.classList.add('active');
        const p = document.getElementById('selDay'); if(m !== 'all') { p.type = (m==='hari'?'date':'month'); p.showPicker(); } else { runFilter(); }
    };

    // INVENTORY MANAGEMENT
    window.renderAdmin = () => {
        document.getElementById('adminList').innerHTML = menus.map(m => `
            <div class="trx-card" style="display:flex; justify-content:space-between; align-items:center"><div style="display:flex; align-items:center; gap:10px"><div style="width:40px; height:40px; border-radius:8px; overflow:hidden; background:#222">${m.image ? `<img src="${m.image}" style="width:100%; height:100%; object-fit:cover">` : ''}</div><div><b>${m.name}</b><br><small>Rp ${m.price.toLocaleString()} | Stok: ${m.stock}</small></div></div><div style="display:flex; gap:8px"><button onclick="editMenu('${m.id}')" style="background:var(--primary); border:none; padding:10px; border-radius:10px">‚úèÔ∏è</button><button onclick="deleteMenu('${m.id}')" style="background:var(--error); border:none; padding:10px; border-radius:10px">üóëÔ∏è</button></div></div>`).join('');
    };

    window.previewImage = (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const MAX_WIDTH = 400; const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    base64String = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('img-preview').src = base64String; document.getElementById('img-preview').style.display = 'block'; document.getElementById('img-placeholder').style.display = 'none';
                };
            }; reader.readAsDataURL(input.files[0]);
        }
    };

    window.saveAdminMenu = async () => {
        const btn = document.getElementById('btnSaveAdmin'); const id = document.getElementById('adm-id').value; const name = document.getElementById('adm-name').value;
        if(!name) return alert("Nama menu wajib!");
        btn.innerText = "PROSES..."; btn.disabled = true;
        const d = { name: name, category: document.getElementById('adm-cat').value, price: parseInt(document.getElementById('adm-price').value) || 0, stock: parseInt(document.getElementById('adm-stock').value) || 0, image: base64String };
        try { id ? await updateDoc(doc(db,"menus",id), d) : await addDoc(collection(db,"menus"), d); closeModal(); base64String = ""; } catch(e) { alert("Error: " + e.message); }
        btn.innerText = "SIMPAN"; btn.disabled = false;
    };

    window.editMenu = (id) => {
        const m = menus.find(x => x.id === id);
        document.getElementById('adm-id').value = m.id; document.getElementById('adm-name').value = m.name; document.getElementById('adm-cat').value = m.category;
        document.getElementById('adm-price').value = m.price; document.getElementById('adm-stock').value = m.stock;
        const preview = document.getElementById('img-preview'); const placeholder = document.getElementById('img-placeholder');
        if(m.image) { base64String = m.image; preview.src = m.image; preview.style.display = 'block'; placeholder.style.display = 'none'; }
        else { base64String = ""; preview.style.display = 'none'; placeholder.style.display = 'block'; }
        document.getElementById('adm-title').innerText = "Edit Menu"; document.getElementById('adminModal').style.display = 'flex';
    };

    // UTILITIES
    window.closeModal = () => document.querySelectorAll('.modal').forEach(m => m.style.display='none');
    window.openAddMenu = () => { document.getElementById('adm-id').value=''; document.getElementById('img-preview').style.display='none'; document.getElementById('img-placeholder').style.display='block'; base64String = ""; document.getElementById('adm-title').innerText="Tambah Menu"; document.getElementById('adminModal').style.display='flex'; };
    window.deleteMenu = async (id) => { if(confirm("Hapus?")) await deleteDoc(doc(db, "menus", id)); };
    window.showNotif = (m) => { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1500); };
    window.resetKasir = () => { cart=[]; updateCart(); document.getElementById('cName').value=''; document.getElementById('successModal').style.display='none'; tab('kasir', document.querySelectorAll('.nav-item')[0]); };
    window.calcChange = () => { const t = cart.reduce((a,b)=>a+(b.price*b.qty),0); const p = parseInt(document.getElementById('payAmount').value) || 0; document.getElementById('payChange').innerText = 'Rp ' + (p-t).toLocaleString(); };
    document.getElementById('menuSearch').addEventListener('input', renderMenuGrid);

    // STRUK PRINTER
    function formatLine(l, r) { const w = 30; let s = w - l.length - r.length; return l + " ".repeat(s < 1 ? 1 : s) + r; }
    function sendToRawBT(t) {
        if(!t) return;
        let p = "        SHAKA COFFEE\n    --- STRUK KASIR ---\n\n";
        p += "Tgl: " + new Date(t.tgl).toLocaleString('id-ID') + "\n";
        p += "Kasir: " + t.kasir + "\nPel: " + t.nama + "\nLok: " + t.lokasi + "\n";
        p += "------------------------------\n";
        t.itemDetails.forEach(it => { p += it.name.toUpperCase() + "\n"; p += formatLine(it.qty + " x " + it.price.toLocaleString(), (it.qty * it.price).toLocaleString()) + "\n"; });
        p += "------------------------------\n";
        p += formatLine("TOTAL", "Rp " + t.total.toLocaleString()) + "\n";
        p += formatLine("TUNAI", "Rp " + t.bayar.toLocaleString()) + "\n";
        p += formatLine("KEMBALI", "Rp " + t.kembali.toLocaleString()) + "\n\n";
        p += "     TERIMA KASIH      \n\n\n";
        const link = "rawbt:base64," + btoa(unescape(encodeURIComponent(p)));
        window.location.href = link;
    }
    window.printStrukLastTrx = () => { if(lastTrxData) sendToRawBT(lastTrxData); };
    window.reprintStruk = (id) => { const t = allTrx.find(x => x.id === id); if(t) sendToRawBT(t); };

</script>
</body>
</html>
